<!doctype html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="favicon.png" />
    <meta charset="UTF-8" />
    <title>CompreSmart ‚Äì Question Bank</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

<style>
/* ==========================================
   BASE  
========================================== */
body {
    margin:0;
    padding:0;
    font-family: "Inter", sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height:100vh;
}
* { box-sizing: border-box; }

.app-container {
    display:flex;
    min-height:100vh;
}

/* ==========================================
   SIDEBAR ‚Äî SAME AS NEW UI  
========================================== */
.sidebar {
    width:80px;
    background:rgba(255,255,255,0.12);
    backdrop-filter: blur(10px);
    border-right:1px solid rgba(255,255,255,0.15);
    padding:24px 16px;
    display:flex;
    flex-direction:column;
    gap:16px;
    position:fixed;
    top:0; left:0;
    height:100vh;
}

.sidebar-icon {
    width:48px;
    height:48px;
    border-radius:14px;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    font-size:24px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.15);
    transition:0.3s;
}
.sidebar-icon:hover {
    background:rgba(255,255,255,0.25);
    transform:translateY(-2px);
}
.sidebar-icon.active {
    background:linear-gradient(135deg, #ffffff55, #ffffff33);
    box-shadow:0 8px 26px rgba(102,126,234,0.45);
}

/* ==========================================
   MAIN CONTENT  
========================================== */
.main-content {
    flex:1;
    margin-left:80px;
    padding:30px;
}
.container {
    max-width:1100px;
    margin:0 auto;
}

/* ==========================================
   HEADER REBUILD  
========================================== */
.page-header {
    background:rgba(255,255,255,0.9);
    padding:26px 32px;
    border-radius:24px;
    backdrop-filter:blur(12px);
    border:1px solid rgba(255,255,255,0.35);
    box-shadow:0 10px 40px rgba(0,0,0,0.12);
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:32px;
}

.header-left {
    display:flex;
    gap:18px;
    align-items:center;
}

.header-icon {
    font-size:36px;
}

.header-text h1 {
    font-size:24px;
    font-weight:700;
    color:#2d3748;
}
.header-text p {
    font-size:14px;
    color:#64748b;
    margin-top:-4px;
}

.profile-area {
    display:flex;
    align-items:center;
    gap:14px;
}

.student-name {
    font-size:14px;
    font-weight:500;
    color:#4a5568;
}

.logout-btn {
    background:#f7fafc;
    border:1px solid #d2d7df;
    padding:8px 16px;
    border-radius:10px;
    font-size:14px;
    cursor:pointer;
    transition:0.2s;
}
.logout-btn:hover {
    background:#edf2f7;
}

/* ==========================================
   TABS  
========================================== */
.tabs {
    display:flex;
    gap:10px;
    margin-bottom:18px;
}
.tab-btn {
    border:none;
    padding:8px 16px;
    border-radius:999px;
    cursor:pointer;
    background:rgba(255,255,255,0.35);
    backdrop-filter:blur(6px);
    color:#fff;
    font-weight:500;
}
.tab-btn.active {
    background:#fff;
    color:#667eea;
}

/* ==========================================
   GLASS CARD  
========================================== */
.glass-card {
    background:rgba(255,255,255,0.92);
    padding:32px;
    border-radius:24px;
    box-shadow:0 12px 40px rgba(0,0,0,0.12);
    border:1px solid rgba(255,255,255,0.35);
    backdrop-filter:blur(14px);
    margin-bottom:26px;
}

.card-header {
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:20px;
}
.card-title {
    font-size:20px;
    font-weight:600;
}

/* ==========================================
   FORMS  
========================================== */
.form-group { margin-bottom:16px; }

.form-label {
    font-size:14px;
    font-weight:600;
    margin-bottom:6px;
}

.form-input,
.form-select,
.form-textarea {
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid #d4d7e2;
    font-size:14px;
}

.form-textarea {
    min-height:80px;
    resize:vertical;
}

.save-btn {
    border:none;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding:10px 22px;
    color:white;
    border-radius:12px;
    cursor:pointer;
    display:inline-flex;
    gap:6px;
    align-items:center;
    font-weight:600;
}

/* ==========================================
   LISTS  
========================================== */
.question-item,
.answer-item {
    background:#f7fafc;
    border:1px solid #e2e8f0;
    padding:18px;
    border-radius:16px;
    margin-bottom:12px;
}

.subject-tag {
    background:#667eea;
    color:white;
    padding:3px 10px;
    border-radius:999px;
    font-size:11px;
}

.empty-state {
    padding:26px;
    text-align:center;
    color:#bcc2d1;
}

/* grading buttons */
.grade-row {
    display:flex;
    gap:10px;
    margin-top:10px;
}
.grade-btn {
    border:none;
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
}
.correct { background:#c6f6d5; color:#22543d; }
.wrong { background:#fed7d7; color:#9b2c2c; }

</style>
</head>

<body>
<div class="app-container">

<!-- SIDEBAR -->
<aside class="sidebar">
    <div class="sidebar-icon" onclick="location.href='index.html'">üìä</div>
    <div class="sidebar-icon" onclick="location.href='reflections.html'">üí≠</div>
    <div class="sidebar-icon active" onclick="location.href='questions.html'">‚ùì</div>
    <div class="sidebar-icon" onclick="location.href='settings.html'">‚öôÔ∏è</div>
</aside>

<!-- MAIN CONTENT -->
<main class="main-content">
<div class="container">

<header class="page-header">
    <div class="header-left">
        <div class="header-icon">‚ùì</div>
        <div class="header-text">
            <h1>Question Bank</h1>
            <p>Create, answer & grade questions.</p>
        </div>
    </div>

    <div class="profile-area">
        <img id="csAvatar" src="" style="width:34px;height:34px;border-radius:50%;object-fit:cover;display:none;border:2px solid #edf2f7;">
        <div class="student-name" id="studentName">Student</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
</header>

<!-- TABS -->
<div class="tabs">
    <button class="tab-btn active" data-tab="add">Add Question</button>
    <button class="tab-btn" data-tab="answer">Answer Questions</button>
    <button class="tab-btn" data-tab="grade">Grade Answers</button>
</div>

<!-- ADD QUESTION TAB -->
<div class="glass-card" id="tab-add">
    <div class="card-header"><span>‚ûï</span><span class="card-title">Add a Question</span></div>

    <form id="questionForm">
        <div class="form-group">
            <label class="form-label">Subject</label>
            <select class="form-select" id="subjectSelect" required>
                <option value="">Loading subjects...</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Question</label>
            <textarea id="questionText" class="form-textarea" required></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Suggested Answer (optional)</label>
            <textarea id="suggestedAnswer" class="form-textarea"></textarea>
        </div>
        <button type="submit" class="save-btn">üíæ Save Question</button>
    </form>

    <hr style="margin:24px 0;border:none;border-top:1px solid #eee;">

    <h3>Your Questions</h3>
    <div id="questionsList"></div>
</div>

<!-- ANSWER TAB -->
<div class="glass-card" id="tab-answer" style="display:none;">
    <div class="card-header"><span>üñäÔ∏è</span><span class="card-title">Answer a Question</span></div>

    <div class="form-group">
        <label class="form-label">Filter by Subject</label>
        <select class="form-select" id="answerSubjectSelect">
            <option value="">All subjects</option>
        </select>
    </div>

    <div id="answerQuestionsList"></div>

    <div id="answerFormContainer" style="margin-top:20px;display:none;">
        <h4>Write your answer</h4>
        <textarea id="studentAnswerText" class="form-textarea"></textarea>
        <button id="submitAnswerBtn" class="save-btn" style="margin-top:12px;">Submit</button>
    </div>
</div>

<!-- GRADE TAB -->
<div class="glass-card" id="tab-grade" style="display:none;">
    <div class="card-header"><span>‚úÖ</span><span class="card-title">Grade Answers</span></div>
    <p style="color:#64748b;font-size:13px;margin-top:-6px;">
        These are answers submitted by students in this question bank.
    </p>
    <div id="answersToGrade"></div>
</div>

</div>
</main>

</div>

    <script>
      // === Backend base URL ===
      const API_BASE = "https://compre-smart-backend-1.onrender.com";

      // ===== login & avatar =====
      const user = localStorage.getItem("cs_user");
      const studentNameEl = document.getElementById("studentName");
      const avatarEl = document.getElementById("csAvatar");

      if (!user) {
        window.location.href = "login.html";
      } else {
        const settingsKey = "cs_settings_" + user;
        const st = JSON.parse(localStorage.getItem(settingsKey) || "{}");
        const displayName = st.displayName || user;
        studentNameEl.textContent = displayName;

        if (st.avatar) {
          avatarEl.src = st.avatar;
          avatarEl.style.display = "block";
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("cs_user");
        window.location.href = "login.html";
      });

      // ===== tabs =====
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = {
        add: document.getElementById("tab-add"),
        answer: document.getElementById("tab-answer"),
        grade: document.getElementById("tab-grade"),
      };
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const target = btn.dataset.tab;
          Object.keys(tabContents).forEach((k) => {
            tabContents[k].style.display = k === target ? "block" : "none";
          });
        });
      });

      // ===== shared QA data (from backend) =====
      let questionsData = [];
      let answersData = [];
      let gradesData = [];

      async function fetchQuestions() {
        try {
          const res = await fetch(API_BASE + "/questions");
          questionsData = await res.json();
        } catch (e) {
          console.error("Error loading questions:", e);
          questionsData = [];
        }
      }

      async function fetchAnswers() {
        try {
          const res = await fetch(API_BASE + "/answers");
          answersData = await res.json();
        } catch (e) {
          console.error("Error loading answers:", e);
          answersData = [];
        }
      }

      async function fetchGrades() {
        try {
          const res = await fetch(API_BASE + "/grades");
          gradesData = await res.json();
        } catch (e) {
          console.error("Error loading grades:", e);
          gradesData = [];
        }
      }

      async function fetchAllQA() {
        await Promise.all([fetchQuestions(), fetchAnswers(), fetchGrades()]);
      }

      // ===== load subjects (local list) =====
      const subjectSelect = document.getElementById("subjectSelect");
      const answerSubjectSelect = document.getElementById("answerSubjectSelect");

      function loadSubjects() {
        const firstSemester = [
          "Understanding the Self",
          "Readings in the Philippine History",
          "Mathematics in the Modern World",
          "Ethics",
          "The Life and Works of Rizal",
        ];
        const secondSemester = [
          "Purposive Communication",
          "Art Appreciation",
          "Science, Technology and Society",
          "The Contemporary World",
        ];

        subjectSelect.innerHTML =
          '<option value="">-- Select subject --</option>';
        answerSubjectSelect.innerHTML =
          '<option value="">All subjects</option>';

        firstSemester.forEach((s) => {
          const opt1 = document.createElement("option");
          opt1.value = s;
          opt1.textContent = "1st Sem ‚Äì " + s;
          subjectSelect.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = s;
          opt2.textContent = "1st Sem ‚Äì " + s;
          answerSubjectSelect.appendChild(opt2);
        });

        secondSemester.forEach((s) => {
          const opt1 = document.createElement("option");
          opt1.value = s;
          opt1.textContent = "2nd Sem ‚Äì " + s;
          subjectSelect.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = s;
          opt2.textContent = "2nd Sem ‚Äì " + s;
          answerSubjectSelect.appendChild(opt2);
        });
      }
      loadSubjects();

      // ===== render "Your questions" (tab add) =====
      const questionsListEl = document.getElementById("questionsList");

      function renderQuestionsList() {
        // only show questions created by this user in "Your questions"
        const qs = questionsData.filter((q) => q.createdBy === user);
        questionsListEl.innerHTML = "";
        if (!qs.length) {
          questionsListEl.innerHTML =
            '<div class="empty-state">No questions yet.</div>';
          return;
        }

        qs
          .sort(
            (a, b) =>
              new Date(b.createdAt).getTime() -
              new Date(a.createdAt).getTime()
          )
          .forEach((q) => {
            const item = document.createElement("div");
            item.className = "question-item";

            const header = document.createElement("div");
            header.className = "question-header";

            const subj = document.createElement("span");
            subj.className = "subject-tag";
            subj.textContent = q.subject;

            const del = document.createElement("button");
            del.className = "delete-btn";
            del.textContent = "üóëÔ∏è";
            del.addEventListener("click", async () => {
              if (!confirm("Delete this question and its answers?")) return;
              try {
                await fetch(API_BASE + "/questions/" + q.id, {
                  method: "DELETE",
                });
                await fetchAllQA();
                renderQuestionsList();
                renderAnswerQuestions();
                renderAnswersToGrade();
              } catch (err) {
                console.error(err);
                alert("Could not delete question (check backend).");
              }
            });

            header.appendChild(subj);
            header.appendChild(del);

            const qtext = document.createElement("div");
            qtext.textContent = q.text;
            qtext.style.fontWeight = "600";
            qtext.style.marginBottom = "6px";

            item.appendChild(header);
            item.appendChild(qtext);

            if (q.suggested && q.suggested.trim() !== "") {
              const ansLabel = document.createElement("div");
              ansLabel.style.fontSize = "12px";
              ansLabel.style.color = "#667eea";
              ansLabel.style.marginBottom = "3px";
              ansLabel.textContent = "Suggested answer";

              const ansBlock = document.createElement("div");
              ansBlock.className = "answer-block";
              ansBlock.textContent = q.suggested;

              item.appendChild(ansLabel);
              item.appendChild(ansBlock);
            }

            const dateEl = document.createElement("div");
            dateEl.className = "question-date";
            dateEl.textContent =
              "Added " +
              new Date(q.createdAt).toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
              });
            item.appendChild(dateEl);

            questionsListEl.appendChild(item);
          });
      }

      // ===== submit question (POST to backend) =====
      const questionForm = document.getElementById("questionForm");
      questionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const subject = subjectSelect.value;
        const qText = document.getElementById("questionText").value.trim();
        const sAns = document.getElementById("suggestedAnswer").value.trim();
        if (!subject || !qText) {
          alert("Please select subject and write question.");
          return;
        }

        try {
          const res = await fetch(API_BASE + "/questions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              subject,
              text: qText,
              suggested: sAns,
              createdBy: user,
            }),
          });
          const created = await res.json();
          questionsData.unshift(created);
          questionForm.reset();
          renderQuestionsList();
          renderAnswerQuestions();
        } catch (err) {
          console.error(err);
          alert("Could not save question (check backend).");
        }
      });

      // ===== tab: Answer Questions =====
      const answerQuestionsListEl =
        document.getElementById("answerQuestionsList");
      const answerFormContainer = document.getElementById(
        "answerFormContainer"
      );
      const studentAnswerText = document.getElementById("studentAnswerText");
      const submitAnswerBtn = document.getElementById("submitAnswerBtn");
      let selectedQuestionId = null;

      function renderAnswerQuestions() {
        const qs = questionsData;
        answerQuestionsListEl.innerHTML = "";
        selectedQuestionId = null;
        answerFormContainer.style.display = "none";
        if (!qs.length) {
          answerQuestionsListEl.innerHTML =
            '<div class="empty-state">No questions available.</div>';
          return;
        }

        const filterSubj = answerSubjectSelect.value;
        const toRender = filterSubj
          ? qs.filter((q) => q.subject === filterSubj)
          : qs;

        if (!toRender.length) {
          answerQuestionsListEl.innerHTML =
            '<div class="empty-state">No questions for that subject.</div>';
          return;
        }

        toRender.forEach((q) => {
          const item = document.createElement("div");
          item.className = "question-item";
          item.style.cursor = "pointer";

          const header = document.createElement("div");
          header.className = "question-header";

          const subj = document.createElement("span");
          subj.className = "subject-tag";
          subj.textContent = q.subject;

          header.appendChild(subj);

          const qtext = document.createElement("div");
          qtext.textContent = q.text;

          item.appendChild(header);
          item.appendChild(qtext);

          item.addEventListener("click", () => {
            selectedQuestionId = q.id;
            answerFormContainer.style.display = "block";
            studentAnswerText.value = "";
          });

          answerQuestionsListEl.appendChild(item);
        });
      }

      answerSubjectSelect.addEventListener("change", renderAnswerQuestions);

      submitAnswerBtn.addEventListener("click", async () => {
        if (!selectedQuestionId) return;
        const ans = studentAnswerText.value.trim();
        if (!ans) return;

        try {
          const res = await fetch(API_BASE + "/answers", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              questionId: selectedQuestionId,
              answerText: ans,
              answeredBy: user,
            }),
          });
          const created = await res.json();
          answersData.unshift(created);
          studentAnswerText.value = "";
          answerFormContainer.style.display = "none";
          renderAnswersToGrade();
          alert("Answer submitted!");
        } catch (err) {
          console.error(err);
          alert("Could not submit answer.");
        }
      });

      // ===== tab: Grade Answers =====
      const answersToGradeEl = document.getElementById("answersToGrade");

      function renderAnswersToGrade() {
    const answers = answersData;
    const questions = questionsData;
    const grades = gradesData;

    answersToGradeEl.innerHTML = "";

    const myAnswersToGrade = answers.filter(ans => {
        const q = questions.find(q => q.id === ans.questionId);
        return q && q.createdBy === user;  // ONLY SHOW YOUR QUESTIONS
    });

    if (!myAnswersToGrade.length) {
        answersToGradeEl.innerHTML =
            '<div class="empty-state">No answers to grade ‚Äî only answer submissions for your questions will appear here.</div>';
        return;
    }

    myAnswersToGrade
        .sort((a, b) =>
            new Date(b.createdAt).getTime() -
            new Date(a.createdAt).getTime()
        )
        .forEach((ans) => {

            const q = questions.find((qq) => qq.id === ans.questionId);
            const card = document.createElement("div");
            card.className = "answer-item";

            const qtitle = document.createElement("div");
            qtitle.style.fontWeight = "600";
            qtitle.textContent = q ? q.text : "(Question deleted)";
            card.appendChild(qtitle);

            const subj = document.createElement("div");
            subj.style.fontSize = "11px";
            subj.style.color = "#64748b";
            subj.textContent = q ? q.subject : "";
            card.appendChild(subj);

            const ansText = document.createElement("div");
            ansText.style.marginTop = "6px";
            ansText.textContent = "Student answer: " + ans.answerText;
            card.appendChild(ansText);

            const existing = grades.find((g) => g.answerId === ans.id);

            // grading UI ‚Äî only visible if the logged-in user owns the question
            if (q.createdBy === user) {
                const gradeRow = document.createElement("div");
                gradeRow.className = "grade-row";

                const feedbackInput = document.createElement("input");
                feedbackInput.className = "form-input";
                feedbackInput.placeholder = "Feedback (optional)";
                feedbackInput.value = existing ? existing.feedback : "";

                const correctBtn = document.createElement("button");
                correctBtn.className = "grade-btn correct";
                correctBtn.textContent = "Correct";

                const wrongBtn = document.createElement("button");
                wrongBtn.className = "grade-btn wrong";
                wrongBtn.textContent = "Incorrect";

                correctBtn.addEventListener("click", () => submitGrade(ans, true, feedbackInput.value));
                wrongBtn.addEventListener("click", () => submitGrade(ans, false, feedbackInput.value));

                gradeRow.appendChild(feedbackInput);
                gradeRow.appendChild(correctBtn);
                gradeRow.appendChild(wrongBtn);

                card.appendChild(gradeRow);
            }

            if (existing) {
                const status = document.createElement("div");
                status.style.marginTop = "4px";
                status.style.fontSize = "12px";
                status.style.color = existing.isCorrect ? "#22543d" : "#9b2c2c";
                status.textContent =
                    "Graded as " +
                    (existing.isCorrect ? "Correct" : "Incorrect") +
                    (existing.feedback ? " ‚Äî " + existing.feedback : "");
                card.appendChild(status);
            }

            answersToGradeEl.appendChild(card);
        });
}

async function submitGrade(ans, isCorrect, feedback) {
    const payload = {
        answerId: ans.id,
        questionId: ans.questionId,
        isCorrect,
        feedback,
        gradedBy: user
    };

    try {
        await fetch(API_BASE + "/grades", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        await fetchGrades();
        renderAnswersToGrade();
        alert("Grade submitted.");
    } catch (err) {
        console.error(err);
        alert("Could not submit grade.");
    }
}


      // initial load from backend then render
      (async () => {
        try {
          await fetchAllQA();
        } catch (err) {
          console.error("Failed to load QA data", err);
        }
        renderQuestionsList();
        renderAnswerQuestions();
        renderAnswersToGrade();
      })();
    </script>

    <script>
      // sidebar navigation (same destinations as index)
      const qNavDashboard = document.getElementById("navDashboard");
      const qNavReflections = document.getElementById("navReflections");
      const qNavQuestions = document.getElementById("navQuestions");
      const qNavSettings = document.getElementById("navSettings");

      if (qNavDashboard) {
        qNavDashboard.addEventListener("click", () => {
          window.location.href = "index.html";
        });
      }

      if (qNavReflections) {
        qNavReflections.addEventListener("click", () => {
          window.location.href = "index.html#reflectionsSection";
        });
      }

      if (qNavQuestions) {
        qNavQuestions.addEventListener("click", () => {
          window.location.href = "questions.html";
        });
      }

      if (qNavSettings) {
        qNavSettings.addEventListener("click", () => {
          window.location.href = "settings.html";
        });
      }
    </script>
  </body>
</html>